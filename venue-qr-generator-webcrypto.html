<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFiProof - Venue QR Generator (Web Crypto)</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" 
            onload="console.log('‚úÖ QRCode library loaded')" 
            onerror="console.error('‚ùå QRCode library failed to load')"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus {
            border-color: #667eea;
            outline: none;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .qr-container {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        .key-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .timestamp-helper {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¢ Venue QR Generator (Web Crypto API)</h1>
        <p style="text-align: center; color: #666;">Using built-in browser crypto - no external dependencies!</p>

        <form id="venueForm">
            <div class="form-group">
                <label for="venueName">Venue Name:</label>
                <input type="text" id="venueName" placeholder="e.g., Downtown Coffee Shop" required>
            </div>

            <div class="form-group">
                <label for="venueId">Venue ID:</label>
                <input type="number" id="venueId" placeholder="e.g., 67890" required>
                <div class="timestamp-helper">Unique identifier for this venue</div>
            </div>

            <div class="form-group">
                <label for="wifiName">WiFi Network Name (SSID):</label>
                <input type="text" id="wifiName" placeholder="e.g., CoffeeShop_Guest" required>
            </div>

            <div class="form-group">
                <label for="eventId">Event ID:</label>
                <input type="number" id="eventId" placeholder="e.g., 20241215" required>
                <div class="timestamp-helper">Unique identifier for this event/time period</div>
            </div>

            <div class="form-group">
                <label for="timeWindowStart">Valid From (Unix Timestamp):</label>
                <input type="number" id="timeWindowStart" required>
                <div class="timestamp-helper">
                    Current time: <span id="currentTimestamp"></span>
                    <button type="button" onclick="setCurrentTime()">Use Current Time</button>
                </div>
            </div>

            <div class="form-group">
                <label for="timeWindowEnd">Valid Until (Unix Timestamp):</label>
                <input type="number" id="timeWindowEnd" required>
                <div class="timestamp-helper">
                    <button type="button" onclick="setTimeFromNow(24)">+24 Hours</button>
                    <button type="button" onclick="setTimeFromNow(168)">+1 Week</button>
                </div>
            </div>

            <div style="text-align: center;">
                <button type="button" onclick="generateKeyPair()">Generate New Venue Keys</button>
                <button type="button" onclick="generateQR()">Generate Signed QR Code</button>
            </div>
        </form>

        <div id="keyInfo" style="display: none;">
            <h3>üîê Venue Cryptographic Keys</h3>
            <div class="key-info">
                <strong>Private Key (JWK):</strong><br>
                <span id="privateKey"></span>
                <br><br>
                <strong>Public Key (JWK):</strong><br>
                <span id="publicKey"></span>
            </div>
            <p class="error">‚ö†Ô∏è Save the private key securely! It's needed to generate valid QR codes for this venue.</p>
        </div>

        <div id="qrResult" class="qr-container" style="display: none;">
            <h3>üì± Generated QR Code</h3>
            <div id="qrCode"></div>
            <div id="qrData" class="key-info"></div>
            <button onclick="downloadQR()">Download QR Code</button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        let currentKeyPair = null;
        let privateKey = null;
        let publicKey = null;

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded - using Web Crypto API!');
            
            // Check if Web Crypto API is available
            if (!window.crypto || !window.crypto.subtle) {
                showStatus('‚ùå Web Crypto API not available in this browser', 'error');
                return;
            }
            
            showStatus('‚úÖ Web Crypto API available - ready to generate keys!', 'success');
            
            // Initialize basic functions
            setCurrentTime();
            setTimeFromNow(24);
            
            // Start timestamp updater
            setInterval(updateCurrentTimestamp, 1000);
            updateCurrentTimestamp();
        });

        // Update current timestamp display
        function updateCurrentTimestamp() {
            const now = Math.floor(Date.now() / 1000);
            const element = document.getElementById('currentTimestamp');
            if (element) {
                element.textContent = now;
            }
        }

        // Set current time in start field
        function setCurrentTime() {
            const now = Math.floor(Date.now() / 1000);
            document.getElementById('timeWindowStart').value = now;
        }

        // Set future time in end field
        function setTimeFromNow(hours) {
            const future = Math.floor(Date.now() / 1000) + (hours * 3600);
            document.getElementById('timeWindowEnd').value = future;
        }

        // Generate ECDSA key pair using Web Crypto API
        async function generateKeyPair() {
            try {
                showStatus('üîÑ Generating cryptographic keys...', 'success');
                
                // Generate ECDSA key pair using P-256 curve (widely supported)
                currentKeyPair = await window.crypto.subtle.generateKey(
                    {
                        name: "ECDSA",
                        namedCurve: "P-256"
                    },
                    true,  // extractable
                    ["sign", "verify"]
                );

                // Export keys in JWK format
                privateKey = await window.crypto.subtle.exportKey("jwk", currentKeyPair.privateKey);
                publicKey = await window.crypto.subtle.exportKey("jwk", currentKeyPair.publicKey);

                // Display the keys
                document.getElementById('privateKey').textContent = JSON.stringify(privateKey, null, 2);
                document.getElementById('publicKey').textContent = JSON.stringify(publicKey, null, 2);
                document.getElementById('keyInfo').style.display = 'block';

                showStatus('‚úÖ Venue key pair generated successfully using Web Crypto API!', 'success');
                console.log('‚úÖ Keys generated:', { privateKey, publicKey });

            } catch (error) {
                console.error('‚ùå Error generating key pair:', error);
                showStatus('‚ùå Error generating key pair: ' + error.message, 'error');
            }
        }

        // Hash function using Web Crypto API
        async function hashFunction(message) {
            const encoder = new TextEncoder();
            const data = encoder.encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = new Uint8Array(hashBuffer);
            return Array.from(hashArray).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Sign message using Web Crypto API
        async function signMessage(message) {
            if (!currentKeyPair) {
                throw new Error('No key pair available');
            }

            const encoder = new TextEncoder();
            const data = encoder.encode(message);
            
            const signature = await window.crypto.subtle.sign(
                {
                    name: "ECDSA",
                    hash: { name: "SHA-256" }
                },
                currentKeyPair.privateKey,
                data
            );

            // Convert signature to hex
            const signatureArray = new Uint8Array(signature);
            return Array.from(signatureArray).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Validate form inputs
        function validateInputs() {
            const venueName = document.getElementById('venueName').value.trim();
            const venueId = document.getElementById('venueId').value.trim();
            const wifiName = document.getElementById('wifiName').value.trim();
            const eventId = document.getElementById('eventId').value.trim();
            const timeWindowStart = document.getElementById('timeWindowStart').value.trim();
            const timeWindowEnd = document.getElementById('timeWindowEnd').value.trim();

            if (!venueName) {
                showStatus('‚ùå Please enter a venue name!', 'error');
                return null;
            }
            if (!venueId || isNaN(parseInt(venueId))) {
                showStatus('‚ùå Please enter a valid venue ID number!', 'error');
                return null;
            }
            if (!wifiName) {
                showStatus('‚ùå Please enter a WiFi network name!', 'error');
                return null;
            }
            if (!eventId || isNaN(parseInt(eventId))) {
                showStatus('‚ùå Please enter a valid event ID number!', 'error');
                return null;
            }
            if (!timeWindowStart || isNaN(parseInt(timeWindowStart))) {
                showStatus('‚ùå Please enter a valid start timestamp!', 'error');
                return null;
            }
            if (!timeWindowEnd || isNaN(parseInt(timeWindowEnd))) {
                showStatus('‚ùå Please enter a valid end timestamp!', 'error');
                return null;
            }

            const startTime = parseInt(timeWindowStart);
            const endTime = parseInt(timeWindowEnd);

            if (endTime <= startTime) {
                showStatus('‚ùå End time must be after start time!', 'error');
                return null;
            }

            return {
                venueName,
                venueId: parseInt(venueId),
                wifiName,
                eventId: parseInt(eventId),
                timeWindowStart: startTime,
                timeWindowEnd: endTime
            };
        }

        // Generate signed QR code
        async function generateQR() {
            console.log('üîÑ Generate QR clicked');

            if (!currentKeyPair) {
                showStatus('‚ùå Please generate venue keys first!', 'error');
                return;
            }

            const formData = validateInputs();
            if (!formData) {
                return; // Validation failed
            }

            try {
                const { venueName, venueId, wifiName, eventId, timeWindowStart, timeWindowEnd } = formData;

                showStatus('üîÑ Generating signed QR code...', 'success');

                // Generate network hash
                const networkHash = await hashFunction(wifiName);

                // Create message to sign
                const venueMessage = {
                    venue_id: venueId,
                    wifi_name: wifiName,
                    network_hash: networkHash,
                    event_id: eventId,
                    time_window_start: timeWindowStart,
                    time_window_end: timeWindowEnd
                };

                const messageToSign = JSON.stringify(venueMessage);
                console.log('üìù Signing message:', messageToSign);

                // Sign the message using Web Crypto API
                const signature = await signMessage(messageToSign);

                // Create QR code data
                const qrData = {
                    venue_name: venueName,
                    venue_id: venueId,
                    wifi_name: wifiName,
                    network_hash: networkHash,
                    event_id: eventId,
                    time_window_start: timeWindowStart,
                    time_window_end: timeWindowEnd,
                    signature: signature,
                    public_key: publicKey,
                    generated_at: Math.floor(Date.now() / 1000),
                    crypto_type: 'WebCrypto-ECDSA-P256'
                };

                console.log('üì± QR Data:', qrData);

                console.log('üéØ QRCode library check:', typeof QRCode);
                
                // Check if QRCode library is available
                if (typeof QRCode === 'undefined') {
                    console.warn('‚ö†Ô∏è QRCode library not available, using fallback');
                    // Fallback: create a simple text representation
                    const qrContainer = document.getElementById('qrCode');
                    qrContainer.innerHTML = `
                        <div style="border: 2px solid #333; padding: 20px; background: white; text-align: left;">
                            <p><strong>‚ö†Ô∏è QR Code Visual (QRCode library not loaded):</strong></p>
                            <p style="font-size: 12px; color: #666;">Copy this data to create QR code manually:</p>
                            <textarea readonly style="width: 100%; height: 150px; font-family: monospace; font-size: 11px;">${JSON.stringify(qrData, null, 2)}</textarea>
                            <p style="font-size: 12px; margin-top: 10px;">
                                <strong>üì± Manual QR Creation:</strong><br>
                                ‚Ä¢ Copy the JSON above<br>
                                ‚Ä¢ Visit qr-code-generator.com<br>
                                ‚Ä¢ Paste and generate QR code
                            </p>
                        </div>
                    `;
                    showStatus('‚ö†Ô∏è QR visual not available. JSON data ready for manual QR generation.', 'error');
                } else {
                    // Generate QR code using QRCode library
                    const qrString = JSON.stringify(qrData);
                    const canvas = document.createElement('canvas');
                    
                    console.log('üì± Generating QR with data length:', qrString.length);

                    QRCode.toCanvas(canvas, qrString, { 
                        width: 300,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    }, function (error) {
                        if (error) {
                            console.error('‚ùå QR generation error:', error);
                            showStatus('‚ùå Error generating QR code: ' + error.message, 'error');
                            
                            // Fallback on QR generation error
                            const qrContainer = document.getElementById('qrCode');
                            qrContainer.innerHTML = `
                                <div style="border: 2px solid #f00; padding: 20px; background: #ffe6e6;">
                                    <p><strong>‚ùå QR Generation Failed</strong></p>
                                    <p>Error: ${error.message}</p>
                                    <textarea readonly style="width: 100%; height: 100px;">${qrString}</textarea>
                                </div>
                            `;
                            return;
                        }

                        const qrContainer = document.getElementById('qrCode');
                        qrContainer.innerHTML = '';
                        qrContainer.appendChild(canvas);

                        // Store canvas for download
                        window.currentQRCanvas = canvas;

                        showStatus('‚úÖ Signed QR code generated successfully using Web Crypto API!', 'success');
                        console.log('‚úÖ QR code generated successfully');
                    });
                }

                // Display QR data
                document.getElementById('qrData').innerHTML =
                    '<strong>QR Code Data:</strong><br>' +
                    JSON.stringify(qrData, null, 2);

                document.getElementById('qrResult').style.display = 'block';

            } catch (error) {
                console.error('‚ùå Error generating QR code:', error);
                showStatus('‚ùå Error generating QR code: ' + error.message, 'error');
            }
        }

        // Download QR code
        function downloadQR() {
            if (window.currentQRCanvas) {
                const link = document.createElement('a');
                link.download = `venue-qr-${document.getElementById('venueId').value}.png`;
                link.href = window.currentQRCanvas.toDataURL();
                link.click();
            } else {
                // Fallback: download JSON data
                const qrData = document.getElementById('qrData').textContent;
                const blob = new Blob([qrData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = `venue-qr-${document.getElementById('venueId').value}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            }
        }

        // Show status messages
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<p class="${type}">${message}</p>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
